---
toc: true
toc_label: "è¿ç»´é€ŸæŸ¥ - æ•°æ®åº“"
toc_icon: "copy"
title: "è¿ç»´é€ŸæŸ¥ - æ•°æ®åº“"
tags: é€ŸæŸ¥ æ•°æ®åº“
categories: "cheatsheet"
classes: wide
excerpt: ""
header:
  overlay_image: /assets/images/header/matrix2.jpg
  overlay_filter: rgba(0, 0, 0, 0.8)
---




### MySQL å¦‚ä½•é‡ç½® root å¯†ç ï¼Ÿ


#### å·²çŸ¥ root å¯†ç çš„æƒ…å†µ

##### åœ¨ shell ä¸­ä¿®æ”¹

```bash
$
```

















## MySQL / MariaDB






### å®‰è£…


#### MySQL

é¦–å…ˆå¿…é¡»ç”¨æµè§ˆå™¨è®¿é—® MySQL çš„ [å®˜æ–¹ä»“åº“](https://dev.mysql.com/downloads/repo/yum/)ï¼Œåœ¨å¯¹åº”çš„å¹³å°ä¸‹é¢å¯ä»¥çœ‹åˆ°è¯¸å¦‚ (mysql80-community-release-el7-1.noarch.rpm) è¿™æ ·çš„æ–‡ä»¶åï¼Œå°†å…¶æ›¿æ¢åˆ°ä¸‹é¢çš„å‘½ä»¤ä¸­è¿›è¡Œä¸‹è½½ã€‚

```bash
$ sudo wget https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm
```

æœ€å¥½è¿›è¡Œä¸€ä¸‹æ ¡éªŒï¼š

```bash
$ md5sum mysql80-community-release-el7-1.noarch.rpm
```

å°†æ ¡éªŒç ä¸ç½‘é¡µä¸Šçš„å¯¹ç…§ã€‚

å®‰è£… MySQL å®˜æ–¹ä»“åº“ï¼š

```bash
$ sudo rpm -ivh mysql80-community-release-el7-1.noarch.rpm
```

æ­£å¼å®‰è£… MySQL Serverï¼š

```bash
$ sudo yum install mysql-server
```

å¯åŠ¨åï¼Œä¼šä¸º root ç”¨æˆ·éšæœºäº§ç”Ÿå¯†ç ï¼š

```bash
$ sudo grep 'temporary password' /var/log/mysqld.log
```


#### MariaDB


```bash
$ sudo yum install mariadb-server
```

MariaDB å®‰è£…æˆåŠŸåï¼Œé»˜è®¤ root å¯†ç ä¸ºç©ºã€‚



#### å®‰å…¨å¤„ç†

```bash
$ sudo mysql_secure_installation
```

åŒ…æ‹¬ root å¯†ç ã€ç§»é™¤åŒ¿åç”¨æˆ·ã€ç¦æ­¢ root è¿œç¨‹ç™»é™†ã€ç§»é™¤æµ‹è¯•æ•°æ®åº“ã€é‡è½½ç”¨æˆ·æƒé™è¡¨ã€‚








### å®ˆæŠ¤è¿›ç¨‹


```bash
$ sudo systemctl status mysqld
$ sudo systemctl enable mysqld
$ sudo systemctl start mysqld

$ sudo systemctl status mariadb
$ sudo systemctl enable mariadb
$ sudo systemctl start mariadb
```






### å¤åˆ¶



#### ä¸€ä¸»å¤šä»ï¼Œä¸»å¤±æ•ˆï¼Œæå‡ä»ä¸ºä¸»

* **æŸ¥çœ‹** æ‰€æœ‰ä»æœåŠ¡å™¨çš„å¤åˆ¶ **ä½ç½®**ï¼š`SHOW SLAVE STATUS` è¿”å›çš„ç»“æœä¸­æŸ¥çœ‹ `Master_Log_Pos`ï¼Œé€‰æ‹©æœ€æ–°çš„åšä¸ºæ–°*ä¸»*
* è®©æ‰€æœ‰*ä»*æŠŠ **ä¸­ç»§æ—¥å¿—æ‰§è¡Œå®Œæ¯•**
* æ–°*ä¸»* **åœæ­¢åšä»**ï¼šåœ¨æ–°ä¸»ä¸Šæ‰§è¡Œ `STOP SLAVE`
* æ–°*ä¸»* **å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—**ï¼šä¿®æ”¹ `my.cnf`ï¼Œå¯ç”¨ `log-bin`ï¼Œé‡å¯ mysql
* æŠŠæ–°*ä¸»* **ä»å…¶åŸä¸»æ–­å¼€**ï¼šæ‰§è¡Œ `CHANGE MASTER TO` åŠ `RESET SLAVE`
* è®°å½•æ–°ä¸»çš„ **äºŒè¿›åˆ¶æ—¥å¿—åæ ‡**ï¼šç”¨ `SHOW MASTER STATUS`
* æ‰€æœ‰ä» **æŒ‡å‘æ–°ä¸»**ï¼šæ‰€æœ‰*ä»*ä¸Šè¿è¡Œ `CHANGE MASTER TO` å‘½ä»¤ï¼ŒæŒ‡å‘æ–°ä¸»ï¼Œä½¿ç”¨ä¸Šä¸€æ­¥è®°ä¸‹æ¥çš„åæ ‡








### å¤‡ä»½ä¸æ¢å¤


#### ä½¿ç”¨äºŒè¿›åˆ¶æ—¥å¿—è¿›è¡Œæ—¶é—´ç‚¹æ¢å¤

å¯ä»¥ç”¨æ­¤æ–¹æ³•æ¢å¤è¢«è¯¯åˆ çš„æ•°æ®åº“ã€‚å…ˆä½¿ç”¨ä¸€ä¸ª **å®Œå…¨å¤‡ä»½** è¿›è¡Œæ¢å¤ï¼Œç„¶åå†è¿›è¡Œæ—¶é—´ç‚¹æ¢å¤ã€‚


##### æ¢å¤å®Œå…¨å¤‡ä»½

æ¢å¤ä¹‹å‰ç”± mysqldump åšçš„å®Œå…¨å¤‡ä»½çš„æ–‡ä»¶ `dump.sql`ï¼š

```bash
$ mysql -uroot -p database_name < dump.sql
```


##### ç¡®å®šå½“å‰äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶

###### æŸ¥çœ‹æ‰€æœ‰äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶

```sql
mysql> SHOW BINARY LOGS;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql-bin.000001 |      1058 |
| mysql-bin.000002 |       178 |
| mysql-bin.000003 |       178 |
|+------------------+-----------+
3 rows in set (0.01 sec)   |   |
```

###### æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶

```sql
mysql> SHOW MASTER STATUS;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000003 |      155 |              |                  |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.01 sec)
```

###### åˆ·æ–°æ—¥å¿—

åˆ·æ–°æ—¥å¿—ï¼Œä»¥ä¾¿è®© MySQL ç”Ÿæˆæ–°çš„äºŒè¿›åˆ¶æ—¥å¿—ï¼Œåœæ­¢å‘åŒ…å«è¯¯æ“ä½œè¯­å¥çš„æ—¥å¿—ä¸­å†™å…¥ã€‚

åœ¨ shell ä¸­æ“ä½œï¼š

```bash
$ mysqladmin -uroot -p -S /data/mysql.sock flush-logs
```

åœ¨ mysql å®¢æˆ·ç«¯æ“ä½œï¼š

```sql
mysql> FLUSH LOGS;
```


##### æŠŠå…³é”®äºŒè¿›åˆ¶æ—¥å¿—è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œè¿›è¡Œä¿®æ”¹

`mysqlbinlog` å¯ä»¥æŠŠäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ä¸­çš„äº‹ä»¶ï¼Œç”±äºŒè¿›åˆ¶æ ¼å¼ **è½¬æ¢** ä¸ºæ–‡æœ¬æ ¼å¼ï¼Œä»¥ä¾¿ç”¨æ¥æ‰§è¡Œæˆ–æŸ¥çœ‹ã€‚

æŠŠäºŒè¿›åˆ¶æ—¥å¿—è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œå¹¶ **ä¿®æ”¹**ï¼š

```bash
shell> mysqlbinlog mysql-bin.000003 > tmpfile
shell> vi tmpfile
```

ğŸš© ç¼–è¾‘æ–‡æœ¬æ–‡ä»¶ï¼Œæ‰¾åˆ°è¯¯æ“ä½œçš„è¯­å¥ï¼Œå¦‚ `DROP DATABASE`ï¼Œå°†å…¶åˆ é™¤ã€‚å¦‚æœæœ‰å…¶å®ƒæƒ³è¦åˆ é™¤çš„ï¼Œå¯ä»¥ä¸€å¹¶è¿›è¡Œã€‚


##### æ‰§è¡Œä¿®æ”¹è¿‡çš„æ—¥å¿—æ–‡ä»¶

å¦‚æœåœ¨ä¿®æ”¹è¿‡çš„æ—¥å¿—ä¹‹å‰ï¼Œæœ‰å¤šä¸ªæ—¥å¿—æ–‡ä»¶è¦ä¾æ¬¡æ‰§è¡Œï¼š

```bash
shell> mysqlbinlog mysql-bin.000001 mysql-bin.000002 | mysql -u root -p
```

ç„¶åå†æ‰§è¡Œä¿®æ”¹è¿‡çš„æ—¥å¿—ï¼š

```bash
shell> mysql -u root -p < tmpfile
```


##### æŒ‰æ—¶é—´æˆ–ä½ç½®æ‰§è¡Œæ—¥å¿—

ä»¥ä¸Šæ­¥éª¤å°±å¯ä»¥å®Œæˆæ¢å¤ä»»åŠ¡äº†ã€‚é™¤äº†ä»¥ä¸Šæ–¹æ³•ï¼Œè¿˜å¯ä»¥å…ˆåœ¨äºŒè¿›åˆ¶æ—¥å¿—ä¸­æŸ¥æ˜è¯¯æ“ä½œå‘ç”Ÿçš„æ—¶é—´å’Œä½ç½®ï¼Œç„¶åç”¨æŒ‡å®šæ—¶é—´èŒƒå›´æˆ–ä½ç½®èŒƒå›´æ¥æ‰§è¡ŒäºŒè¿›åˆ¶æ—¥å¿—ã€‚

åŸºäºæ—¶é—´èŒƒå›´æ¥æ¢å¤ï¼š

```bash
mysqlbinlog --start-datetime="2005-04-20 10:01:00" \
            --stop-datetime="2005-04-20 9:59:59" mysql_bin.000001 \
            | mysql -u root -ppassword database_name
```

åŸºäºä½ç½®èŒƒå›´æ¥æ¢å¤ï¼š

```bash
mysqlbinlog --start-position=368315 \
            --stop-position=368312 mysql_bin.000001 \
            | mysql -u root -ppassword database_name
```




### ç›‘æ§


#### æŸ¥çœ‹å½“å‰è¿›ç¨‹

åœ¨ shell ä¸­æŸ¥çœ‹ï¼š

```bash
mysqladmin processlist -uroot -p -h 127.0.0.1
Enter password:
+----+-----------------+-----------------+----+---------+-------+--------------------------------------------------------+------------------+
| Id | User            | Host            | db | Command | Time  | State                                                  | Info             |
+----+-----------------+-----------------+----+---------+-------+--------------------------------------------------------+------------------+
| 4  | system user     |                 |    | Connect | 20045 | Connecting to master                                   |                  |
| 5  | system user     |                 |    | Query   | 7947  | Slave has read all relay log; waiting for more updates |                  |
| 6  | event_scheduler | localhost       |    | Daemon  | 20045 | Waiting on empty queue                                 |                  |
| 17 | root            | localhost:33820 |    | Query   | 0     | starting                                               | show processlist |
+----+-----------------+-----------------+----+---------+-------+--------------------------------------------------------+------------------+
```

ä½¿ç”¨ `-h` æ˜¯ä¸ºäº†é€šè¿‡ TCP socket è¿æ¥ï¼Œä»¥ä¾¿åœ¨ç»“æœä¸­æ˜¾ç¤ºè¿æ¥çš„ç«¯å£å·ã€‚

åœ¨ mysql å®¢æˆ·ç«¯æŸ¥çœ‹ï¼š

```sql
mysql> SHOW PROCESSLIST;     
+----+-----------------+-----------+------+---------+-------+------------------------+------------------+
| Id | User            | Host      | db   | Command | Time  | State                  | Info             |
+----+-----------------+-----------+------+---------+-------+------------------------+------------------+
|  4 | event_scheduler | localhost | NULL | Daemon  | 20110 | Waiting on empty queue | NULL             |
|  8 | root            | localhost | NULL | Query   |     0 | starting               | SHOW PROCESSLIST |
+----+-----------------+-----------+------+---------+-------+------------------------+------------------+
2 rows in set (0.00 sec)
```
