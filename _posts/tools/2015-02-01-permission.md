---
toc: true
toc_label: "Linux çš„ä½¿ç”¨ - æƒé™æ§åˆ¶"
toc_icon: "book"
title: "Linux çš„ä½¿ç”¨ - æƒé™æ§åˆ¶"
tags: linux umask sudo su æƒé™
category: "tools"
classes: wide
excerpt: "ä¼ ç»Ÿçš„ Linux æƒé™æ§åˆ¶ï¼ŒSELinux"
header:
  overlay_image: /assets/images/header/access-control-systems.jpg
  overlay_filter: rgba(0, 0, 0, 0.6)
published: false
---



## æƒé™æ§åˆ¶çš„ç±»åˆ«

* MACï¼šMandatory Access Controlï¼Œ**å¼ºåˆ¶** è®¿é—®æ§åˆ¶ã€‚
* DACï¼šDiscretionary Access Controlï¼Œ**è‡ªç”±** è®¿é—®æ§åˆ¶ã€‚
* RBACï¼šRole Based Access Controlï¼ŒåŸºäº **è§’è‰²** çš„è®¿é—®æ§åˆ¶ã€‚

ä¼ ç»Ÿçš„ Linux æƒé™æ§åˆ¶å…¶ä¸»ä½“æ˜¯ **UID** åŠ **GID**ã€‚


### DAC

Discretionary Access Controlï¼Œ**è‡ªç”±** è®¿é—®æ§åˆ¶ã€‚å®ƒåé‡äº **å¯ç”¨æ€§**ï¼Œå®ƒçš„å†³ç­–æ˜¯åŸºäº **æƒé™**ã€‚

DAC è®©ç”¨æˆ·ç®¡ç†è‡ªå·±çš„æ•°æ®ã€‚å¦‚åœ¨çº¿ç¤¾åŒºç½‘ç»œä¸­ï¼Œè®©ç”¨æˆ·è‡ªè¡Œé€‰æ‹©è°å¯ä»¥è®¿é—®ä»–ä»¬çš„æ•°æ®ã€‚é€šè¿‡ DAC ï¼Œç”¨æˆ·å¯ä»¥è½»æ¾åœ°ç«‹å³åºŸé™¤æˆ–è½¬å‘æƒé™ã€‚


### RBAC

Role Based Access Controlï¼ŒåŸºäº **è§’è‰²** çš„è®¿é—®æ§åˆ¶ã€‚å®ƒçš„å†³ç­–æ˜¯åŸºäº **åŠŸèƒ½** æˆ– **è§’è‰²**ã€‚

RBAC é€‚ç”¨äºåœ¨ä¸€ä¸ªç³»ç»Ÿä¸­æŠŠå„é¡¹è´£ä»»æ‹†å¼€ï¼Œåˆ†é…ç»™ä¸åŒçš„è§’è‰²ã€‚RBAC æ—¢é€‚ç”¨äºä¼ä¸šï¼Œä¹Ÿé€‚ç”¨äºå•ç”¨æˆ·æ“ä½œç³»ç»Ÿï¼Œç”¨æ¥å®æ–½æœ€å°æƒé™åŸåˆ™ã€‚RBAC çš„è®¾è®¡åˆè¡·æ˜¯ï¼šé€šè¿‡å…è®¸ç”¨æˆ·ä¸ºç‰¹å®šä»»åŠ¡é€‰æ‹©è‡ªå·±è§’è‰²ï¼Œæ¥ **æ‹†åˆ†è´£ä»»**ã€‚å› æ­¤å…³é”®çš„é—®é¢˜æ˜¯ï¼Œä½ æ˜¯å¦ä½¿ç”¨è§’è‰²æ¥å®Œæˆç‰¹å®šçš„ä»»åŠ¡ï¼Œå¹¶ä¸”éœ€è¦ç»ç”±ç»Ÿä¸€æˆæƒæ¥åˆ†é…è§’è‰²ã€‚æˆ–è€…ä½ éœ€è¦ä½¿ç”¨è§’è‰²ï¼Œæ¥è®©ç”¨æˆ·åœ¨è‡ªå·±çš„å¯¹è±¡ä¸Šæ§åˆ¶æƒé™ï¼Œå¯¼è‡´æ¯ä¸ªå¯¹è±¡å¯ä»¥ä½¿ç”¨ä¸åŒçš„è§’è‰²ã€‚


### MAC

Mandatory Access Controlï¼Œ**å¼ºåˆ¶** è®¿é—®æ§åˆ¶ã€‚

MAC çš„æ¦‚å¿µæœ¬èº«æœ‰äº›æ¨¡ç³Šï¼Œå®ƒçš„å®ç°æœ‰è®¸å¤šæ–¹å¼ã€‚å®ƒé€‚ç”¨äºå¯¹ **ä¿å¯†çº§åˆ«** è¦æ±‚è¾ƒé«˜çš„æƒ…å†µï¼Œå®ƒçš„å†³ç­–æ˜¯å…ˆåŸºäº **æ ‡ç­¾**ï¼Œç„¶åæ˜¯ **æƒé™**ã€‚

åœ¨ç”Ÿäº§ä¸­ï¼Œç»å¸¸ä½¿ç”¨ä¸åŒæƒé™æ§åˆ¶çš„ç»„åˆã€‚ä¾‹å¦‚ï¼Œåœ¨ UNIX ç³»ç»Ÿä¸­ï¼Œæœ€å¸¸ç”¨ä½¿ç”¨çš„æ˜¯ DAC ï¼Œä½† root å¸æˆ·å´å¯ä»¥ç»•è¿‡å…¶é™åˆ¶ã€‚åœ¨ä¼ä¸šä¸­ï¼Œé™¤äº†ç”¨ MAC / RBAC æ¥ä¸ºå„éƒ¨é—¨åˆ†é…æƒé™ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å…è®¸é€šè¿‡ CAC åœ¨åŒäº‹ä¹‹é—´å…±äº«ä¿¡æ¯ã€‚






















## æ–‡ä»¶æƒé™


### `umask`

è®¾ç½®é»˜è®¤æƒé™æ©ç 

`umask [ -S ] [ Mask ]`

`-S`	ç”¨ç¬¦å·è¡¨ç¤ºå½“å‰æƒé™æ©ç 

å¦‚æœä¸å¸¦å‚æ•°è¿è¡Œï¼Œ`umask` å‘½ä»¤ç›´æ¥æ˜¾ç¤ºå½“å‰æ©ç 

`umask a=rx,ug+w`	ä»¥ç¬¦å·æ–¹å¼è®¾ç½®

`umask 002`	ä»¥æ•°å­—æ–¹å¼è®¾ç½®

`umask -S`	ä»¥ç¬¦å·æ–¹å¼æ˜¾ç¤ºå½“å‰è®¾ç½®

`umask g-w`		ç»„å»æ‰ä¿®æ”¹æƒé™

`umask -- -w`	æ‰€æœ‰äººå»æ‰ä¿®æ”¹æƒé™





### `chmod`

`chmod` ç”¨äºä¿®æ”¹æ–‡ä»¶çš„æƒé™ä½ã€‚

`chmod [å‚æ•°] æ–‡ä»¶å`

`chmod -R 777 /path/`	 **é€’å½’** ä¿®æ”¹ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶

`chmod u=rwx,go=rx file`	åŒæ—¶ä¿®æ”¹ U/G/O æƒé™

`chmod a+w file`	å•ç‹¬ä¿®æ”¹ rwx æƒé™

`chmod 4755 file`	ä¿®æ”¹ SUIDã€SGIDã€SBIT






### `chown`

ä¿®æ”¹æ–‡ä»¶æ‰€æœ‰è€…ã€å±ç»„

`chown [å‚æ•°] ç”¨æˆ· æ–‡ä»¶`

`-R`	é€’å½’å¤„ç†ï¼Œå°†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŠå­ç›®å½•ä¸€å¹¶å¤„ç†

`-v`	æ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹

`--reference=`	æŠŠæŒ‡å®šæ–‡ä»¶æˆ–ç›®å½•çš„æ‰€å±ç¾¤ç»„å…¨éƒ¨æ”¹ä¸ºå’Œå‚è€ƒæ–‡ä»¶æˆ–ç›®å½•çš„æ‰€å±ç¾¤ç»„ç›¸åŒ

* èŒƒä¾‹

`chown -R newuser file`	ä¿®æ”¹æ‰€æœ‰è€…

`chown -R newuser:newgroup file`  	åŒæ—¶ä¿®æ”¹æ‰€æœ‰è€…åŠå±ç»„

`chown -R :newgroup file`	ä¿®æ”¹æ–‡ä»¶çš„å±ç»„ä¸ºå¦ä¸€ä¸ªç°æœ‰ç»„





### `chgrp`

ä¿®æ”¹æ–‡ä»¶å±ç»„

`chgrp [å‚æ•°] ç»„ æ–‡ä»¶`

`-R`	é€’å½’å¤„ç†ï¼Œå°†æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶åŠå­ç›®å½•ä¸€å¹¶å¤„ç†

`-v`	æ˜¾ç¤ºæŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹

`--reference=`	æŠŠæŒ‡å®šæ–‡ä»¶æˆ–ç›®å½•çš„æ‰€å±ç¾¤ç»„å…¨éƒ¨æ”¹ä¸ºå’Œå‚è€ƒæ–‡ä»¶æˆ–ç›®å½•çš„æ‰€å±ç¾¤ç»„ç›¸åŒ

* èŒƒä¾‹

`chgrp -R anothergroup file`	ä¿®æ”¹æ–‡ä»¶çš„å±ç»„ä¸ºå¦ä¸€ä¸ªç°æœ‰ç»„















## æ–‡ä»¶å±æ€§




### `chattr`  

`chattr` å‘½ä»¤ç”¨äºä¿®æ”¹æ–‡ä»¶å±æ€§ï¼Œä½†åªèƒ½åœ¨ EXT ä¸­å®Œæ•´ç”Ÿæ•ˆï¼ŒXFS ç³»ç»Ÿä¸­ä»…æ”¯æŒéƒ¨ä»½å‚æ•°ã€‚

`chattr [ -RVf ] [ -v version ] [ -p project ] [ mode ] files...`

`A`	**é”å®š atime**ï¼Œå¯å‡å°‘ I/Oã€‚

`a`	**åªèƒ½è¿½åŠ ** å†…å®¹ï¼Œä¸èƒ½åˆ é™¤æ–‡ä»¶ï¼Œä¸èƒ½ä¿®æ”¹ï¼Œé™ **è¶…çº§ç”¨æˆ·** ä½¿ç”¨

`d`	ä¸è¢« dump å¤‡ä»½

`i`	ç¦æ­¢ **åˆ é™¤ã€æ”¹åã€é“¾æ¥ã€ä¿®æ”¹**ï¼Œé™ **è¶…çº§ç”¨æˆ·** ä½¿ç”¨

`S`	å°†æ–‡ä»¶çš„ä¿®æ”¹ **åŒæ­¥** å†™å…¥ç£ç›˜ã€‚

EXT æ–‡ä»¶ç³»ç»Ÿæ”¯æŒæ‰€æœ‰å‚æ•°ï¼ŒXFS ä»…æ”¯æŒ `AadiS`ã€‚
{: .notice--warning}

`c`	è¯»ä¹‹å‰è‡ªåŠ¨è§£å‹ï¼Œå†™ä¹‹å‰å…ˆå‹ç¼©

`s`	å¦‚æœåˆ é™¤æ–‡ä»¶ï¼Œä¼šè¢«å®Œå…¨ç§»é™¤å‡ºç¡¬ç›˜ç©ºé—´ï¼Œæ— æ³•æ¢å¤

`u`	åˆ é™¤æ–‡ä»¶åï¼Œæ•°æ®ä»å­˜åœ¨ç£ç›˜ï¼Œå¯ä»¥æ¢å¤

* èŒƒä¾‹

`chattr +i`	é”å®šæ–‡ä»¶ï¼Œç¦æ­¢æ”¹åã€ä¿®æ”¹ã€åˆ é™¤ã€é“¾æ¥

`chattr +a`	æ–‡ä»¶åªå…è®¸è¿½åŠ å†…å®¹ï¼Œä¸èƒ½åˆ é™¤ã€ä¿®æ”¹

`chattr +d`	ä¸ä¼šè¢« dump å¤‡ä»½

`chattr +A`	é”å®š atimeï¼Œå‡å°‘ IO

`chattr +S`	æœ‰å˜åŒ–æ—¶ **åŒæ­¥** å†™å…¥ç£ç›˜






### `lsattr`  

æŸ¥çœ‹æ–‡ä»¶ **éšè—å±æ€§**

`lsattr -a`	æŸ¥çœ‹å½“å‰ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬éšè—æ–‡ä»¶çš„éšè—å±æ€§

`lsattr -d`	ä»…æŸ¥çœ‹ç›®å½•æœ¬èº«çš„éšè—å±æ€§

`lsattr -R`	æŸ¥çœ‹è¿åŒå­ç›®å½•çš„éšè—å±æ€§





### `setfattr`


ä½¿ç”¨ `setfattr` æ¥è®¾ç½®æ‰©å±•å±æ€§

`setfattr [-h] -n name [-v value] pathname...`

`-n`	æŒ‡å®šå±æ€§åï¼Œç”¨æˆ·æ‰©å±•å±æ€§å¿…é¡»ç”¨å‰ç¼€ `user.` æ¥å‘½å

`-v`	æŒ‡å®šå±æ€§çš„å€¼

`-x`	åˆ é™¤æŒ‡å®šæ‰©å±•å±æ€§ï¼Œæ¥å±æ€§å

* èŒƒä¾‹

`setfattr -n user.cell -v "13099999999" file`
















## ACL





### æŸ¥çœ‹ç³»ç»Ÿæ˜¯å¦æ”¯æŒ ACL

`dmesg | grep -i acl`





### `getfacl`

`getfacl`  ç”¨äºæŸ¥çœ‹æ–‡ä»¶çš„ ACL æ¡ç›®

`getfacl filename`





### `setfacl`

`setfacl` ç”¨äºè®¾ç½®ã€ä¿®æ”¹ã€åˆ é™¤æ™®é€šæ–‡ä»¶å’Œç›®å½•çš„è®¿é—®æ§åˆ¶åˆ—è¡¨ã€‚

`setfacl [-bkRd] [{-m|-x} aclå‚æ•°] ç›®æ ‡æ–‡ä»¶å`

`setfacl -m <æ¡ç›®> <æ–‡ä»¶>`


`-m`  **ä¿®æ”¹** ACL æ¡ç›®

`-x`  **åˆ é™¤** ACL æ¡ç›®

`-b`  **åˆ é™¤æ‰€æœ‰** çš„ ACL è®¾ç½®

`-R`  **é€’å½’** è®¾ç½® ACL

`-d`  è®¾ç½®ç›®å½•çš„ **é»˜è®¤ ACL**

`-k`  **åˆ é™¤é»˜è®¤ ACL**

`--set` å’Œ `--set-file` ç”¨äºè®¾ç½®æ–‡ä»¶æˆ–ç›®å½•çš„ ACL æ¡ç›®ï¼Œå…ˆå‰çš„è®¾å®šå°†è¢«è¦†ç›–

`-M` ä¿®æ”¹ ACL æ¡ç›®ï¼Œ**ä»æ–‡ä»¶æˆ– STDIN è¯»å–** ACL æ¡ç›®

`-X` åˆ é™¤ ACL æ¡ç›®ï¼Œ**ä»æ–‡ä»¶æˆ– STDIN è¯»å–** ACL æ¡ç›®

å½“ä½¿ç”¨ `-M`ï¼Œ`-X` é€‰é¡¹ä»æ–‡ä»¶ä¸­è¯»å–è§„åˆ™æ—¶ï¼Œ`setfacl` æ¥å— `getfacl` å‘½ä»¤è¾“å‡ºçš„æ ¼å¼ã€‚æ¯è¡Œè‡³å°‘ä¸€æ¡è§„åˆ™ï¼Œä»¥ `#` å¼€å§‹çš„è¡Œå°†è¢«è§†ä¸ºæ³¨é‡Šã€‚
{: .notice}  





#### èŒƒä¾‹

* ä¸ºæŒ‡å®šç”¨æˆ·è®¾å®šæƒé™

`setfacl -m u:user1:rx file`

* ä¸ºæ–‡ä»¶æ‰€æœ‰è€…è®¾å®šæƒé™

`setfacl -m u::rwx file`

`u` åé¢ç•™ç©ºï¼Œè¡¨ç¤ºé’ˆå¯¹æ–‡ä»¶ **æ‰€æœ‰è€…**ã€‚

* ä¸ºæŒ‡å®šç”¨æˆ·è®¾å®šæƒé™ï¼Œç©º

`setfacl -m u:pro3:- /srv/projecta`

è®¾ç½®ç”¨æˆ·å¯¹ç›®å½• **æ— ä»»ä½•æƒé™**ï¼Œæƒé™å­—æ®µç”¨ **`-`**ï¼Œä¸èƒ½ç•™ç©ºã€‚

* ä¸ºæŒ‡å®šç»„è®¾å®šæƒé™

`setfacl -m g:mygroup1:rx file`

* è®¾å®šæœ‰æ•ˆæƒé™æ©ç 

`setfacl -m m:r file`

å€ŸåŠ© mask æ¥è®¾å®šæœ€å¤§æƒé™ï¼Œå¯ä»¥é¿å…æƒé™è¯¯åˆ†é…ã€‚
{: .notice--success}

* åˆ é™¤æŒ‡å®šç”¨æˆ·æƒé™

`setfacl -x u:500 /project/somefile`

* ä¸ºç›®å½•è®¾å®šé»˜è®¤ ACL

é€šè¿‡è®¾ç½®ç›®å½•å¯¹äºç‰¹å®šç”¨æˆ·çš„é»˜è®¤æƒé™ï¼Œä½¿è¿™äº›ç”¨æˆ·åœ¨ç›®å½•å†…æ–°å»ºçš„æ–‡ä»¶èƒ½å¤Ÿç»§æ‰¿å…¶ ACLã€‚

åªéœ€åœ¨è§„åˆ™å‰åŠ ä¸Š `d:`

`setfacl -m d:u:myuser1:rx /srv/projecta`
























## åˆ‡æ¢ç”¨æˆ·



### `su`

`su` åœ¨æŸä¸ªç™»é™†ä¼šè¯ä¸­ï¼Œå˜æˆå…¶ä»–ç”¨æˆ·ã€‚

`su [options] [name]`

å¦‚æœä¸æŒ‡å®šç”¨æˆ·åï¼Œåˆ™ä¼šåˆ‡æ¢åˆ° rootã€‚

`-c command` ä¸´æ—¶ä½¿ç”¨æŒ‡å®šç”¨æˆ·çš„ shell è¿è¡Œå‘½ä»¤

`-`/`-l`  ä»¥ login shell æ–¹å¼åˆ‡æ¢ï¼Œæä¾›è¯¥ç”¨æˆ·ç™»é™†åçš„ç¯å¢ƒã€‚

`-m`  ä¿ç•™å½“å‰çš„ç¯å¢ƒå˜é‡ï¼ˆ$PATH, $IFS é™¤å¤–ï¼‰

#### èŒƒä¾‹


* ä»¥ non-login shell æ–¹å¼åˆ‡æ¢ root

`su`  ç¯å¢ƒå˜é‡ä»ä¸ºåŸç”¨æˆ·çš„

* ç”¨ login shell åˆ‡æ¢ root

`su -` ç¯å¢ƒå˜é‡æ›´æ–°ä¸º root çš„

* ä¸´æ—¶æ‰§è¡Œå‘½ä»¤

`su - -c "head -n 3 /etc/shadow"`

ä¸´æ—¶ç”¨ root èº«ä»½æ‰§è¡Œï¼Œå‘½ä»¤å®Œæˆä¹‹åä»æ˜¯åŸèº«ä»½

* åˆ‡æ¢ä¸ºå…¶ä»–ç”¨æˆ·

`su -l user1` ä»¥ login shell æ–¹å¼åˆ‡æ¢ï¼Œè·å¾—æ–°ç”¨æˆ·ç¯å¢ƒå˜é‡









### `sudo`

`sudo [-b] [-u æ–°ç”¨æˆ·å¸å·]`


`-b`   æŠŠå‘½ä»¤ç½®äºåå°è¿è¡Œ

`-u`   æŒ‡å®šåˆ‡æ¢çš„ç”¨æˆ·ï¼Œçœç•¥åˆ™åˆ‡æ¢ä¸º root



#### é…ç½®æ–‡ä»¶

`sudo` ä¸“ç”¨çš„é…ç½®æ–‡ä»¶ä¸º `/etc/sudoers`ï¼Œä½†ä¸èƒ½ç›´æ¥ä¿®æ”¹ï¼Œä¸€å®šè¦ä½¿ç”¨ **`visudo`** æ¥ç¼–è¾‘ã€‚

å¦‚æœåªæ˜¯è¦å¢åŠ  sudoersï¼Œå»ºè®®åœ¨ `/etc/sudoers.d/` ç›®å½•ä¸­æ–°å»ºè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œç”¨ `sudo visudo -f /etc/sudoers.d/neo` æ¥ç¼–è¾‘è¯¥æ–‡ä»¶æ¥å®ç°ï¼Œæ—¢å®‰å…¨ï¼Œåˆçµæ´»ã€‚
{: .notice--success}



##### ä¸ºç‰¹å®šç”¨æˆ·å¢åŠ  SUDO æƒé™

```conf
neo ALL=(ALL) ALL
```

##### ä¸ºç‰¹å®šç»„å¢åŠ  SUDO æƒé™

ä¸é…ç½®ç”¨æˆ·çš„åŒºåˆ«å°±æ˜¯åœ¨ç»„åå‰é¢åŠ ä¸Šç™¾åˆ†å· `%`ã€‚

```conf
%wheel ALL=(ALL) ALL
```

##### å…è®¸å…è¾“å¯†ç ä½¿ç”¨ SUDO

```conf
neo ALL=NOPASSWD: ALL
%wheel ALL=NOPASSWD: ALL
```

è¿™æ ·é…ç½®ä»¥åï¼Œç”¨æˆ·ä½¿ç”¨ sudo å‘½ä»¤æ—¶æ— éœ€å†è¾“å…¥å¯†ç ã€‚



#### èŒƒä¾‹

* ä»¥å…¶ä»–èº«ä»½åˆ›å»ºæ–‡ä»¶

`sudo -u sshd touch /tmp/mysshd`


* ä»¥å…¶ä»–èº«ä»½æ‰§è¡Œè„šæœ¬

`sudo sh -c "cd /home ; du -s * | sort -rn > USAGE"`






















## SELinux






### é…ç½®æ–‡ä»¶

`/etc/selinux/config` æ˜¯ SELinux çš„ä¸»è¦é…ç½®æ–‡ä»¶ï¼Œå®ƒæ§åˆ¶ç€ SELinux å¯åŠ¨è¿˜æ˜¯ç¦ç”¨ï¼Œä»¥åŠå½“å‰ä½¿ç”¨å“ªä¸ª SELinux æ¨¡å¼ã€å“ªä¸ªç­–ç•¥ã€‚

é€šè¿‡ç¼–è¾‘ `/etc/selinux/config` é…ç½®æ–‡ä»¶ï¼Œæ¥åˆ‡æ¢ SELinux çŠ¶æ€æˆ–æ¨¡å¼ã€‚

```
SELINUX=enforcing/permissive/disabled
```









### çŠ¶æ€ä¸æ¨¡å¼

`getenforce`  æŸ¥çœ‹ SELinux å½“å‰å·¥ä½œæ¨¡å¼

`setenforce 0`  åˆ‡æ¢åˆ°å®½å®¹æ¨¡å¼

`setenforce 1`  åˆ‡æ¢åˆ°å¼ºåˆ¶æ¨¡å¼



#### ç³»ç»Ÿå¯åŠ¨æ—¶æŒ‡å®šå‚æ•°

`enforcing=0`  è®©ç³»ç»Ÿä»¥å®½å®¹æ¨¡å¼å¯åŠ¨

`selinux=0`  ç¦ç”¨ SELinux

`autorelabel=1`  åˆ›å»º `/.autorelabel`ï¼Œç„¶åé‡å¯









### ä¸Šä¸‹æ–‡



#### æŸ¥çœ‹ä¸Šä¸‹æ–‡

`ls -Z` æŸ¥çœ‹æ–‡ä»¶å’Œç›®å½•çš„ä¸Šä¸‹æ–‡

`id -Z` æŸ¥çœ‹å½“å‰ L ç”¨æˆ·çš„ä¸Šä¸‹æ–‡

`ps -eZ | grep httpd`  æŸ¥çœ‹ç‰¹å®šè¿›ç¨‹çš„ä¸Šä¸‹æ–‡



#### ä¸Šä¸‹æ–‡æ“ä½œ


##### ä¿®æ”¹ä¸Šä¸‹æ–‡

`chcon -t samba_share_t /var/www/html/testfile`  ä¿®æ”¹æ–‡ä»¶ç±»å‹

`chcon -v --reference=/etc/shadow /etc/cron.d/checktime`  å‚è€ƒæ–‡ä»¶è‡ªåŠ¨ä¿®æ”¹ä¸Šä¸‹æ–‡

`restorecon -v /usr/sbin/httpd`  ä¿®å¤æ–‡ä»¶ä¸Šä¸‹æ–‡

`restorecon -FR -v /home/neo`  ä¿®æ”¹ç›®å½•ä¸Šä¸‹æ–‡

å…äº RELABEL çš„ä¿®æ”¹æ–¹å¼ï¼š

```bash
~]# semanage fcontext -a options file-name|directory-name
~]# restorecon -v file-name|directory-name
```


##### æ ‡ç­¾ç»´æŠ¤

`cp --preserve=context file /tmp/` å¤åˆ¶æ—¶ä¿ç•™åŸä¸Šä¸‹æ–‡

`cp --context=system_u:object_r:samba_share_t:s0` å¤åˆ¶æ—¶æŒ‡å®šç›®æ ‡æ–‡ä»¶çš„ä¸Šä¸‹æ–‡

`matchpathcon -V /var/www/html/*`  æ£€æŸ¥è¯¥ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶çš„ä¸Šä¸‹æ–‡æ˜¯å¦æ­£ç¡®

`tar --selinux`  æ‰“åŒ…æˆ–è§£åŒ…æ—¶ä¿ç•™ä¸Šä¸‹æ–‡ï¼Œä¸ç”¨å‚æ•°è§£åŒ…æ—¶ä¼šç»§æ‰¿ç›®æ ‡ç›®å½•çš„ä¸Šä¸‹æ–‡




#### æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ

`mount -o context=SELinux_user:role:type:level`  æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿæ—¶ä½¿ç”¨ä¸Šä¸‹æ–‡å‚æ•°

å½“æ–‡ä»¶ç³»ç»Ÿ **æŒ‚è½½æ—¶ä½¿ç”¨äº† `context` å‚æ•°** æ—¶ï¼Œç³»ç»Ÿä¼š **ç¦æ­¢ç”¨æˆ·å’Œè¿›ç¨‹ä¿®æ”¹ä¸Šä¸‹æ–‡**ï¼Œ`chcon` ä¼šè¿”å› `Operation not supported` é”™è¯¯ã€‚
{: .notice--warning}


##### ç”¨æŒ‚è½½å‚æ•°æ§åˆ¶æœåŠ¡å¯¹ NFS çš„è®¿é—®


å¸Œæœ› **ç¦æ­¢** å…¶å®ƒæœåŠ¡è®¿é—®æŒ‚è½½çš„ NFSï¼ŒæŒ‚è½½æ—¶ **ä¸åŠ é¢å¤–å‚æ•°**

```
~]# mount server:/export /local/mount/point
```

å¸Œæœ› **å…è®¸** ç½‘é¡µæœåŠ¡è®¿é—®æŒ‚è½½çš„ NFSï¼Œå¯ä»¥ä¸ºå…¶ **æŒ‡å®š** ç½‘é¡µæœåŠ¡ä¸“ç”¨çš„ **ç±»å‹**ï¼š

```
~]# mount server:/export /local/mount/point -o \
context="system_u:object_r:httpd_sys_content_t:s0"
```


##### ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿçš„é»˜è®¤ä¸Šä¸‹æ–‡

```
~]# mount /dev/sda2 /test/ -o defcontext="system_u:object_r:samba_share_t:s0"
```


##### NFS åŒä¸€å¯¼å‡ºç›®å½•ä¸åŒå­ç›®å½•ï¼Œç”¨ä¸åŒç±»å‹åˆ†åˆ«æŒ‚è½½

```
~]# mount server:/export/web /local/web \
-o nosharecache,context="system_u:object_r:httpd_sys_content_t:s0"
#                                          ^^^^^^^^^^^^^^^^^^^

~]# mount server:/export/database /local/database \
-o nosharecache,context="system_u:object_r:mysqld_db_t:s0"
#                                          ^^^^^^^^^^^
```


##### `/etc/fstab` ä¸­æŒ‡å®šæŒ‚è½½å‚æ•°

```
server:/export /local/mount/ nfs context="system_u:object_r:httpd_sys_content_t:s0" 0 0
```









### å¸ƒå°”å€¼

`semanage boolean -l`  æŸ¥çœ‹å¸ƒå°”å€¼åç§°ã€æè¿°ã€å¼€å…³çŠ¶æ€

`getsebool -a`  æŸ¥çœ‹å¸ƒå°”å€¼åç§°ã€å¼€å…³çŠ¶æ€

`getsebool boolean-name1 boolean-name2`  æŸ¥çœ‹æŒ‡å®šåç§°çš„å¸ƒå°”å€¼çŠ¶æ€

`setsebool -P guest_exec_content off`  å…³æ‰å¸ƒå°”å€¼

`-P` å‚æ•°åšå‡ºçš„æ”¹å˜ä¼šæŒç»­ç”Ÿæ•ˆï¼Œå› æ­¤å¦‚æœä¸å¸Œæœ›åœ¨é‡å¯åè¿˜æœ‰æ•ˆï¼Œå°±ä¸è¦ä½¿ç”¨ `-P` å‚æ•°ã€‚
{: .notice--warning}










### ä¿¡æ¯åˆ†æ



#### `seinfo` æŸ¥è¯¢ SELinux ç­–ç•¥ä¸­çš„å„è¦ç´ 

`seinfo` ç”¨äºæŸ¥è¯¢ SELinux ç­–ç•¥ä¸­çš„å„è¦ç´ ï¼Œèº«ä»½ã€è§’è‰²ã€ç±»å‹ã€è§„åˆ™ã€‚å®ƒä½¿ç”¨ `policy.conf`ã€äºŒè¿›åˆ¶ç­–ç•¥æ–‡ä»¶ã€ç­–ç•¥åŒ…çš„æ¨¡å—åŒ–åˆ—è¡¨æˆ–ä¸€ä¸ªç­–ç•¥åˆ—è¡¨æ–‡ä»¶åšä¸ºè¾“å…¥ã€‚å…¶è¾“å‡ºä¹Ÿä¼šæ ¹æ®ä¸åŒçš„è¾“å…¥è€Œæœ‰æ‰€åŒºåˆ«ã€‚

`seinfo [-trub]`

`--all`   æŸ¥çœ‹æ‰€æœ‰è¦ç´ ï¼šSELinux çŠ¶æ€ã€è§„åˆ™ã€èº«ä»½ã€è§’è‰²ã€ç±»å‹

`-u`		æŸ¥çœ‹æ‰€æœ‰èº«ä»½

`-r`		æŸ¥çœ‹æ‰€æœ‰è§’è‰²

`-t`		æŸ¥çœ‹æ‰€æœ‰ç±»å‹

`-b`		æŸ¥çœ‹æ‰€æœ‰è§„åˆ™

`seinfo -u`  æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨

`seinfo -r` æŸ¥çœ‹æ‰€æœ‰è§’è‰²




#### `avcstat` æœ¬æ¬¡å¼€æœºä»¥æ¥ AVC çš„ç®€è¦ç»Ÿè®¡

`avcstat`  æŸ¥çœ‹æœ¬æ¬¡å¼€æœºä»¥æ¥ AVC çš„ç®€è¦ç»Ÿè®¡




#### `sestatus` æŸ¥è¯¢ SELinux å½“å‰çŠ¶æ€ä¿¡æ¯


* SELinux å½“å‰çŠ¶æ€ï¼Œå¯åŠ¨æˆ–å…³é—­
* SELinux å…³é”®ç›®å½•çš„ä½ç½®ï¼Œ/etc/selinux
* å½“å‰å·²è½½å…¥çš„ç­–ç•¥åç§°
* SELinux çš„æŒ‚è½½ç‚¹
* å½“å‰å·¥ä½œæ¨¡å¼
* é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„å·¥ä½œæ¨¡å¼
* MLS çŠ¶æ€
* å¯¹äºæœªå®šä¹‰æ“ä½œï¼Œæ˜¯å¦é»˜è®¤é‡‡å–æ‹’ç»

`sestatus -v`   æŸ¥çœ‹ SELinux å½“å‰çŠ¶æ€ä¿¡æ¯

`sestatus -b`   æŸ¥çœ‹æ‰€æœ‰å¸ƒå°”å€¼åˆ—è¡¨ï¼Œå·¦ä¾§ä¸ºåç§°ï¼Œå³ä¾§ä¸ºå¸ƒå°”å€¼





#### `semanage` é…ç½®ç­–ç•¥ä¸­çš„å„è¦ç´ 

`semanage {login|user|port|interface|fcontext|translation} -l `

`semanage` ç”¨äºé…ç½®ç­–ç•¥ä¸­çš„ **ç‰¹å®šè¦ç´ **ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ç­–ç•¥æºæ–‡ä»¶ã€‚

* **L ç”¨æˆ·åˆ° SL ç”¨æˆ·çš„æ˜ å°„**ã€‚è¯¥æ˜ å°„æ§åˆ¶ç€ L ç”¨æˆ·ç™»é™†åè·å¾—æˆæƒè§’è‰²æ—¶ï¼Œç³»ç»Ÿä¸ºå…¶åˆ†é…çš„åˆå§‹ä¸Šä¸‹æ–‡ã€‚
* **ä¸ºå„ç§ä¸åŒç±»åˆ«çš„å®¢ä½“åˆ†é…çš„ä¸Šä¸‹æ–‡æ˜ å°„**ã€‚ä¸»è¦æŒ‡ç½‘ç»œç«¯å£ã€ç½‘ç»œæ¥å£ã€ç½‘ç»œä¸»æœºç­‰ç±»åˆ«ã€‚
* **æ–‡ä»¶ä¸Šä¸‹æ–‡çš„æ˜ å°„**ã€‚

`semanage login` ç”¨äºç”± Linux login ç”¨æˆ·æ˜ å°„åˆ° SL ç”¨æˆ·ã€‚

`semanage user` ç”¨äºç”± SL ç”¨æˆ·æ˜ å°„åˆ°è§’è‰²ç»„ï¼ˆä¸€ç”¨æˆ·å¯ä»¥æœ‰å¤šè§’è‰²ï¼‰ã€‚

å¤šæ•°æ—¶é—´é‡Œï¼Œç®¡ç†å‘˜åªéœ€è¦ä½¿ç”¨ `semanage login` æ¥è®¾ç½®ï¼Œåè€…åŸåˆ™ä¸Šæ˜¯ç”±åŸºç¡€ç­–ç•¥æ¨¡å—å®šä¹‰çš„ï¼Œé€šå¸¸ä¸éœ€è¦ä¿®æ”¹ã€‚


##### ä¿®æ”¹ç›®å½•é»˜è®¤ä¸Šä¸‹æ–‡

é»˜è®¤ä½¿ç”¨ `targeted` `ç­–ç•¥æ—¶ï¼Œsemanage` æŸ¥è¯¢åˆ°çš„å…³äºä¸Šä¸‹æ–‡çš„ä¿¡æ¯éƒ½æ¥è‡ªäº `/etc/selinux/targeted/contexts/files/` ç›®å½•ä¸­çš„å„ä¸ªæ–‡ä»¶ã€‚

`semanage fcontext -{a|d|m} [-frst] file_spec`

`fcontext`	è®¾ç½®å®‰å…¨ä¸Šä¸‹æ–‡

`-l`			æŸ¥è¯¢

`-a`			å¢åŠ 

`-m`			ä¿®æ”¹

`-d`			åˆ é™¤


##### ç”¨æˆ·æ“ä½œ

* æŸ¥çœ‹ L ç”¨æˆ·å’Œ SL ç”¨æˆ·çš„æ˜ å°„

	`semanage login -l`

* åˆ›å»ºæ–° SL ç”¨æˆ·ï¼Œå¹¶æŒ‡å®šå…¶é»˜è®¤è§’è‰²åŠé™„åŠ çš„å—é™ç®¡ç†å‘˜è§’è‰²

	`semanage user -a -r s0-s0:c0.c1023 -R "staff_r webadm_r" neo_u`

* æŠŠæ–°å»º SL ç”¨æˆ·æ˜ å°„ç»™ç°æœ‰ L ç”¨æˆ· `neo`

	`semanage login -a -s neo_u -rs0:c0.c1023 neo`

* æ–°å»º L ç”¨æˆ·æ—¶ï¼ŒæŒ‡å®šå…¶ XL çš„æ˜ å°„å¯¹è±¡

	`useradd -Z user_u user`

* ä¿®æ”¹ç°æœ‰ç”¨æˆ·çš„æ˜ å°„

	`semange login -a -s neo_u neo`  åŸ SL ç”¨æˆ·å¯èƒ½ä¸º `unconfined_u`ï¼Œä¿®æ”¹ä¸º `neo_u`

* ä¿®æ”¹é»˜è®¤æ˜ å°„

	`semanage login -m -S targeted -s "user_u" -r s0 __default__`


#####  èŒƒä¾‹ï¼šæŸ¥çœ‹ `/etc` `/etc/cron.d` ä¸¤ä¸ªç›®å½•çš„é»˜è®¤ä¸Šä¸‹æ–‡

> æ€è·¯ï¼šå…ˆç”¨ `semanage fcontext -l` åˆ—å‡ºç³»ç»Ÿä¸­æ‰€æœ‰æ–‡ä»¶ä¸Šä¸‹æ–‡çš„å®šä¹‰ï¼Œæœ‰å‡ åƒæ¡ï¼Œç„¶åä½¿ç”¨ grep è¿‡æ»¤ã€‚

```
~]#semanage fcontext -l | grep -E '^/etc |^/etc/cron'
SELinux fcontext type Context
/etc all files system_u:object_r: etc_t :s0
/etc/cron\.d(/.*)? all files system_u:object_r: system_cron_spool_t :s0
```

`semanage fcontext -l` è¿”å›çš„ç»“æœæ ¼å¼ï¼š

`æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼ˆæ­£åˆ™è¡¨è¾¾å¼)  æ–‡ä»¶ç§ç±»  ä¸Šä¸‹æ–‡`

ç”±æŸ¥è¯¢ç»“æœå¯çŸ¥ï¼Œ`/etc` ç›®å½•çš„é»˜è®¤æ–‡ä»¶ç±»å‹ä¸º etc_tï¼›`/etc/cron.d` ç›®å½•çš„é»˜è®¤æ–‡ä»¶ç±»å‹ä¸º `system_cron_spool_t`ã€‚


##### èŒƒä¾‹ï¼šè®¾ç½®æ–°å»ºç›®å½•çš„é»˜è®¤ä¸Šä¸‹æ–‡ç±»å‹

ğŸ˜ˆ æ–°å»ºçš„ç›®å½•æ˜¯ä¸å­˜åœ¨çš„ä¸Šä¸‹æ–‡é»˜è®¤å€¼çš„ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ›å»ºï¼Œä»¥ä¾¿ä¹‹ååœ¨è¯¥ç›®å½•å¯ä»¥éšæ—¶ä½¿ç”¨ `restorecon` å‘½ä»¤ã€‚æœ¬ä¾‹åªåˆ›å»ºå…¶é»˜è®¤çš„ **æ–‡ä»¶ç±»å‹**ã€‚

```
~]# mkdir /srv/mycron
~]# semanage fcontext -a -t system_cron_spool_t "/srv/mycronï¼ˆ/.*ï¼‰?"
```





#### `sesearch` åœ¨ç­–ç•¥ä¸­æŸ¥æ‰¾ç‰¹å®šçš„è§„åˆ™

å¯ä»¥åœ¨ç­–ç•¥æºæ–‡ä»¶ä¸­æŸ¥æ‰¾ï¼Œä¹Ÿå¯ä»¥åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­æŸ¥æ‰¾ã€‚

`sesearch [-A] [-s ä¸»ä½“ç±»å‹] [-t å®¢ä½“ç±»å‹] [-b è§„åˆ™åç§°]`

`-A`  ä»…æŸ¥çœ‹æ”¾è¡Œçš„è§„åˆ™

`-C`  æ˜¾ç¤ºæ¡ä»¶è¡¨è¾¾å¼åŠçŠ¶æ€

>`sesearch -C` ä¼šåœ¨è¿”å›ç»“æœçš„å¼€å¤´åŠ ä¸Šä¸¤ä¸ªå­—æ¯ï¼Œç¬¬ä¸€ä¸ªå­—æ¯è¡¨ç¤º **æœ¬æ¡è§„åˆ™å½“å‰çŠ¶æ€**ï¼Œç¬¬äºŒä¸ªå­—æ¯è¡¨ç¤º **å¸ƒå°”å€¼çš„å“ªä¸ªçŠ¶æ€ä¼šå¯ç”¨æœ¬æ¡è§„åˆ™**ã€‚
> E D T F åˆ†åˆ«ä¸º Enabled, Disabled, True, False çš„é¦–å­—æ¯ã€‚
> * ETï¼šæœ¬è§„åˆ™å½“å‰å¯ç”¨ï¼Œå¸ƒå°”å€¼æ‰“å¼€æ—¶ä¼šå¯ç”¨æœ¬è§„åˆ™
> * EFï¼šæœ¬è§„åˆ™å½“å‰å¯ç”¨ï¼Œå¸ƒå°”å€¼å…³é—­æ—¶ä¼šå¯ç”¨æœ¬è§„åˆ™
> * DTï¼šæœ¬è§„åˆ™å½“å‰ç¦ç”¨ï¼Œå¸ƒå°”å€¼æ‰“å¼€æ—¶ä¼šå¯ç”¨æœ¬è§„åˆ™
> * DFï¼šæœ¬è§„åˆ™å½“å‰ç¦ç”¨ï¼Œå¸ƒå°”å€¼å…³é—­æ—¶ä¼šå¯ç”¨æœ¬è§„åˆ™

`-s`  æŒ‡å®šä¸»ä½“ç±»å‹ï¼ŒåŸŸ

`-t`  æŒ‡å®šå®¢ä½“ç±»å‹ï¼Œæ–‡ä»¶ç±»å‹

`-b`  æŒ‡å®šè§„åˆ™åç§°

`sesearch` è¿”å›çš„æ ¼å¼æ˜¯è¿™æ ·çš„ï¼š

```
  allow crond_t setfiles_exec_t : file { read getattr execute open } ;
# æ§åˆ¶ |   åŸŸ  |     ç±»å‹       | å®¢ä½“  |           æ“ä½œ
```


##### èŒƒä¾‹ï¼šæŒ‡å®šçš„åŸŸæœ‰æƒè®¿é—®å“ªäº›ç±»å‹çš„æ–‡ä»¶

è¿è¡Œäº `crond_t` åŸŸä¸­çš„è¿›ç¨‹æ˜¯å¦æœ‰æƒè®¿é—®ä¸ `spool` ç›¸å…³çš„æ–‡ä»¶ã€‚

å…ˆæŸ¥è¯¢è¯¥åŸŸæ‰€å…è®¸çš„æ‰€æœ‰è§„åˆ™ï¼Œå†ä»¥å…³é”®å­—è¿‡æ»¤ï¼š

```
~]# sesearch -A -s crond_t | grep spool
   allow crond_t system_cron_spool_t : file { ioctl read write create } ;
#   æ”¾è¡Œ   åŸŸ        æ–‡ä»¶ç±»å‹
```

æŸ¥è¯¢ç»“æœè¡¨æ˜ï¼š`crond_t` åŸŸä¸­çš„è¿›ç¨‹å…è®¸è®¿é—® `system_cron_spool_t` ç±»å‹çš„æ–‡ä»¶ã€‚


##### èŒƒä¾‹ï¼šæŒ‡å®šçš„åŸŸæ˜¯å¦æœ‰æƒè®¿é—®ç‰¹å®šæ–‡ä»¶

è¿è¡Œäº `crond_t` åŸŸä¸­çš„è¿›ç¨‹æ˜¯å¦æœ‰æƒè®¿é—® `/etc/cron.d/checktime` æ–‡ä»¶ã€‚

å…ˆæŸ¥çœ‹è¯¥æ–‡ä»¶çš„ SL ç±»å‹ï¼Œå†æŸ¥è¯¢è¯¥åŸŸæ˜¯å¦æœ‰æƒè®¿é—®è¯¥ç±»å‹ã€‚

```
~]# ll -Z /etc/cron.d/checktime  
-rw-r--r--. root root unconfined_u:object_r:admin_home_t:s0 /etc/cron.d/checktime
#                                            ^^^^^ç±»å‹
```

æŸ¥è¯¢ `crond_t` åŸŸçš„æ‰€æœ‰è§„åˆ™ï¼Œä»ä¸­æŠŠ `admin_home_t` ç­›é€‰å‡ºæ¥ï¼š

```
~]# sesearch -A -s crond_t | grep admin_home_t
#                                              ^^^^^^^^^^
   allow domain admin_home_t : dir { getattr search open } ;
   allow domain admin_home_t : lnk_file { read getattr } ;
   allow crond_t admin_home_t : dir { ioctl read getattr lock search open } ;
   allow crond_t admin_home_t : lnk_file { read getattr } ;
```

è™½ç„¶æœ‰ `crond_t` `admin_home_t` çš„è§„åˆ™ï¼Œä½†ä¸æ˜¯é’ˆå¯¹æ–‡ä»¶çš„ï¼Œå› æ­¤ `crond_t` åŸŸä¸­çš„è¿›ç¨‹æ— æƒè®¿é—® `admin_home_t` ç±»å‹çš„æ–‡ä»¶ã€‚


##### èŒƒä¾‹ï¼šæŸ¥çœ‹æŸä¸ªå¸ƒå°”å€¼æ‰€å½±å“çš„æ‰€æœ‰è§„åˆ™

è¦çŸ¥é“å¸ƒå°”å€¼çš„å®Œæ•´åç§°ï¼Œé€šè¿‡è¯¥å‘½ä»¤å¯ä»¥äº†è§£è¯¥å¸ƒå°”å€¼å¼€æˆ–å…³æ—¶ï¼Œä¼šå½±å“åˆ°å“ªäº›å…·ä½“çš„è§„åˆ™çš„çŠ¶æ€ã€‚å¸ƒå°”å€¼å¼€çš„æ—¶å€™ï¼Œæœ‰å“ªäº›è§„åˆ™ä¼šå¯ç”¨ï¼Œå“ªäº›ä¼šç¦ç”¨ï¼Œä»¥åŠå¸ƒå°”å€¼å…³çš„æ—¶å€™çš„æƒ…å†µã€‚

ä»…æŸ¥çœ‹å¸ƒå°”å€¼å½±å“çš„è§„åˆ™ï¼š

```
~]# sesearch -A -b httpd_enable_homedirs
#                       å¸ƒå°”å€¼åç§°
Found 72 semantic av rules:
   allow httpd_suexec_t user_home_dir_t : dir { getattr search open } ;
   allow httpd_t nfs_t : lnk_file { read getattr } ;
```

æŸ¥çœ‹å¸ƒå°”å€¼å½±å“è§„åˆ™çš„åŒæ—¶ï¼Œæ˜¾ç¤ºæ¡ä»¶è¡¨è¾¾å¼åŠçŠ¶æ€ï¼š

```
root #sesearch -b user_dmesg -AC
Found 4 semantic av rules:
ET allow user_t kernel_t : system syslog_read ; [ user_dmesg ]
ET allow user_t user_t : capability2 syslog ; [ user_dmesg ]
ET allow staff_t kernel_t : system syslog_read ; [ user_dmesg ]
ET allow staff_t staff_t : capability2 syslog ; [ user_dmesg ]
```


##### èŒƒä¾‹ï¼šå“ªäº›è§’è‰²å¯ä»¥è®¿é—®æŒ‡å®šç±»å‹çš„æ–‡ä»¶

ç”¨ `--role_allow` å‚æ•°æ¥æŸ¥æ‰¾ï¼Œå“ªäº›è§’è‰²å¯ä»¥è®¿é—® `httpd_sys_content_t` ç±»å‹çš„æ–‡ä»¶ï¼š

```
~]$ sesearch --role_allow -t httpd_sys_content_t
Found 20 role allow rules:
   allow system_r sysadm_r;
   allow sysadm_r system_r;
   allow sysadm_r staff_r;
......
```


























## æ¡ˆä¾‹







### SELinux æ’é”™





#### `vsftpd` æœåŠ¡å¸¸é‡åˆ°çš„é—®é¢˜


##### vsftpd æœåŠ¡è¦æ±‚

åŒ¿åç”¨æˆ·ï¼š

* ç”¨æµè§ˆå™¨è¿æ¥åˆ° FTP æœåŠ¡å™¨æ—¶ï¼Œé»˜è®¤ç”¨åŒ¿åç”¨æˆ·ç™»é™†ç³»ç»Ÿã€‚
* åŒ¿åç”¨æˆ·çš„ä¸»æ–‡ä»¶å¤¹é»˜è®¤ä¸º `/var/ftp`
* åŒ¿åç”¨æˆ·åªæœ‰æƒè®¿é—®ä¸»æ–‡ä»¶å¤¹ï¼Œåªèƒ½ä¸‹è½½ä¸èƒ½ä¸Šä¼ 

æ™®é€šå¸å·ï¼š

* é»˜è®¤ UID å¤§äº 1000 çš„å¸å·éƒ½å¯ä»¥è®¿é—® FTP
* æ‰€æœ‰å¸å·åªå…è®¸è®¿é—®è‡ªå·±çš„ä¸»æ–‡ä»¶å¤¹
* æ‰€æœ‰å¸å·å¯ä»¥ä¸Šä¼ ã€ä¸‹è½½


##### å‡†å¤‡æµ‹è¯•ç¯å¢ƒ

æ–°å»ºæµ‹è¯•å¸å·

```
~]# useradd -s /sbin/nologin ftptest  
~]# echo "myftp123" | passwd --stdin ftptest
```

åŒ¿åç”¨æˆ·é€šå¸¸çš„ä¸»ç›®å½•ä¸º `/var/ftp/pub` ã€‚

æŠŠ `/etc/securetty` å’Œ `/etc/sysctl.conf` å¤åˆ¶åˆ° `/var/ftp/pub` æä¾›ä¸‹è½½ï¼š

```
~]# cp -a /etc/securetty /etc/sysctl.conf /var/ftp/pub
~]# ll /var/ftp/pub
```

åœ¨ ftptest ç”¨æˆ·çš„ä¸»æ–‡ä»¶å¤¹åˆ›å»ºæ–‡ä»¶

```
~]# echo "testing" > ~/test.txt
~]# cp -a /etc/hosts /etc/sysctl.conf .
```

å®‰è£… vsftpd å¹¶è®¾ç½®å¼€æœºå¯åŠ¨

```
~]# yum install /mnt/Packages/vsftpd-3*
~]# systemctl start vsftpd
~]# systemctl enable vsftpd
```


##### åŒ¿åç”¨æˆ·æ— æ³•ä¸‹è½½æŸäº›æ–‡ä»¶

æŸ¥çœ‹æ–‡ä»¶ rwx æƒé™æ˜¯å¦æ­£å¸¸ã€‚


##### æ™®é€šç”¨æˆ·ä»å®¶ç›®å½•ä¹‹å¤–çš„ç›®å½•ä¸Šä¼ /ä¸‹è½½æ–‡ä»¶

å‡è®¾æƒ³æä¾› `/srv/go` è¿™ä¸ªç›®å½•ç»™ ftptest ç”¨æˆ·ä½¿ç”¨ï¼š

```
~]# mkdir /srv/go
~]# chgrp ftptest /srv/go
~]# echo "test" > /srv/go/test.txt

~]# curl ftp://ftptest:myftp123@localhost/srv/go/test.txt
curl: ï¼ˆ78ï¼‰ RETR response: 550
```

æ‹’ç»è®¿é—®ï¼ŒæŸ¥ä¸€ä¸‹æ—¥å¿—ï¼Œçœ‹æœ‰æ²¡æœ‰ SELinux çš„è­¦å‘Šæ¶ˆæ¯ï¼š

```
~]# grep sealert /var/log/messages | tail
Aug  9 04:23:12 station3-39 setroubleshoot: SELinux is preventing /usr/sbin/vsftpd from
 read access on the file test.txt. For complete SELinux messages. run sealert -l
 08d3c0a2-5160-49ab-b199-47a51a5fc8dd
~]# sealert -l 08d3c0a2-5160-49ab-b199-47a51a5fc8dd
SELinux is preventing /usr/sbin/vsftpd from read access on the file test.txt.
```

åœ¨ sealert è¿”å›çš„æ¶ˆæ¯ä¸­æœ‰ä¸€æ¡æœ‰ç”¨çš„å»ºè®®ï¼š

```
# semanage fcontext -a -t FILE_TYPE 'test.txt'
```

å®ƒå»ºè®®ä½ å¢åŠ ä¸€æ¡è§„åˆ™ï¼ŒæŠŠè¿™ä¸ªæ–‡ä»¶çš„æ–‡ä»¶ç±»å‹æ”¹ä¸º ftp æœ‰æƒè¯»å–çš„ï¼Œæœ€å¿«æ·çš„æ–¹æ³•å°±æ˜¯ç›´æ¥æŸ¥çœ‹ `/var/ftp` ç›®å½•çš„é»˜è®¤æ–‡ä»¶ç±»å‹ï¼š

```
~]# ll -Zd /var/ftp
drwxr-xr-x. root root system_u:object_r:public_content_t:s0 /var/ftp
#                                       ^^^^^^^^^^^^^^^^
```

å€Ÿç”¨ setroubleshoot çš„å»ºè®®ï¼Œä¸ºäº†ä¸€åŠ³æ°¸é€¸ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨è§„åˆ™ä¸­æŒ‡å®š `/srv/go` ç›®å½•ä¸­æ‰€æœ‰æ–‡ä»¶ï¼Œä»¥ä¾¿æ—¥åéšæ—¶å¯ä»¥ç”¨ `restorecon` æ¥çº æ­£ï¼š

```
~]# semanage fcontext -a -t public_content_t "/srv/goï¼ˆ/.*ï¼‰?"
~]# restorecon -Rv /srv/go
~]# curl ftp://ftptest:myftp123@localhost//srv/gogogo/test.txt
test
```


##### ä¿®æ”¹ vsftpd ç«¯å£å·

```
~]# vim /etc/vsftpd/vsftpd.conf
# æ–°å¢ä¸€è¡Œï¼š
listen_port=555
```

é‡å¯ vsftpd æœåŠ¡åå‡ºé”™ï¼š

```
~]# systemctl restart vsftpd
Job for vsftpd.service failed because the control process exited with error code. See "systemctl status vsftpd.service" and "journalctl -xe" for details.
```

æ£€æŸ¥æ—¥å¿—ï¼š

```
~]# grep sealert /var/log/messages | tail
Oct 27 16:16:18 zion setroubleshoot: SELinux is preventing /usr/sbin/vsftpd from name_bind access on the tcp_socket port 555. For complete SELinux messages run: sealert -l 3588594e-a1dd-431f-913d-0b94f576f31e
```

æ‰§è¡Œå®Œ sealert ä¹‹åï¼Œsetroubleshoot ç»™çš„å»ºè®®ï¼š

```
# semanage port -a -t PORT_TYPE -p tcp 555
```

å› ä¸ºç°æœ‰è§„åˆ™ä¸­æ²¡æœ‰æ”¾è¡Œ 555 ç«¯å£çš„è§„åˆ™ï¼Œæˆ‘ä»¬è¦æ–°å»ºï¼š

```
~]# semanage port -a -t ftp_port_t -p tcp 555
~]# systemctl restart vsftpd

~]# netstat -tlnp
tcp6       0      0 :::555           :::*              LISTEN   8436/vsftpd

~]# curl ftp://localhost:555/pub/
-rw-r--r--    1 0        0             221 Oct 29  2014 securetty
-rw-r--r--    1 0        0             225 Mar 06 03:05 sysctl.conf
```
